## 仕様差分まとめ（2025-09-03）

- 対象仕様: `docs/detailed_design_spec.md`, `_input/AI分析エンジン/制御・最終レポートエージェント仕様.md`, `_input/AI分析エンジン/全体性能差分分析エージェント仕様.md`, `_input/AI分析エンジン/個別データ分析エージェント仕様.md`
- 実装確認範囲: `src/ai_analysis_engine/**`, `config/default_config.yaml`, `scripts/run_analysis.py`, `pyproject.toml`, `templates/`, `tests/`, `outputs/`

### 差分一覧（仕様 ⇄ 現状実装）

1) テンプレート/レポート生成（優先度: 高）
- 仕様: Jinja2で `report_template.md.j2`, `instance_report_template.md.j2`, `email_template.html.j2`
- 実装: `templates/` 空。`Orchestrator` はプレーン文字列でMD生成。

2) ベースライン比較（優先度: 高）
- 仕様: DataWareHouseから過去集計/指定JSONを取得して比較
- 実装: `PerformanceAnalyzer._compare_with_baseline` はハードコード値。

3) RAG/LLM/期待値エージェント（優先度: 高）
- 仕様: 仕様/コード検索 + LLMで仮説生成・検証、自然言語期待値パース
- 実装: 簡易ヒューリスティックのみ。RAG/LLM/期待値パーサは未実装。

4) 並列実行/リトライ（優先度: 中）
- 仕様: 個別分析を並列化し、指数バックオフで再試行
- 実装: 逐次処理。スケジューラ/リトライ未実装。

5) 成果物の出力先（優先度: 高）
- 仕様: ローカル `outputs/` に加えて `../DataWareHouse/05_analysis_output/` へMD/画像/JSONを格納
- 実装: JSONはDWH配下に保存・登録あり。レポート/図表はローカルのみ。`summary_reports.md/json` 未出力。

6) 可視化（優先度: 中）
- 仕様: 静的画像（標準）、必要に応じてROC/PR
- 実装: 時系列/混同行列/性能比較バーのみ。ROC/PR未実装。混同行列は `scikit-learn` 依存未宣言。棒グラフの値ラベルのフォーマット不備。

7) DataWareHouse連携・ID整合（優先度: 中）
- 仕様: 適切なIDで登録、例外/Txハンドリング
- 実装: `evaluation_result_id` と `algorithm_output_id` の扱いが分かりづらい箇所あり。型付き例外/Txは限定的。

8) 設定/環境（優先度: 中）
- 仕様: `production_config.yaml`, `development_config.yaml`、uv運用
- 実装: `default_config.yaml` のみ。環境切替/uv手順は未整備。

9) パッケージ/エントリポイント（優先度: 高）
- 仕様: CLI実行可能
- 実装: `pyproject.toml` のエントリポイントが実体 (`scripts/run_analysis.py`) と不整合。

10) ユーティリティ構成（優先度: 低）
- 仕様: `utils/rag_system.py`, `utils/visualization.py` 等
- 実装: 未実装。

11) テスト（優先度: 中）
- 仕様: unit/integration/fixtures
- 実装: `tests/` 空。

12) 依存関係（優先度: 中）
- 仕様: `pandasai`, `pandasai-openai`, `langchain-openai`, `plotly`, `jinja2` など
- 実装: `plotly/pandasai/langchain-openai/scikit-learn` 未追加。

13) ロギング（優先度: 低）
- 仕様: JSON Lines（`orchestrator_logs.jsonl` 等）
- 実装: テキストログのみ。

14) APIインターフェース（優先度: 低）
- 仕様: 抽象HTTP API
- 実装: CLIのみ。

### 既知の細部不整合
- `PerformanceAnalyzer._create_performance_comparison_plot` の値ラベルが固定文字列。
- 混同行列生成は依存未宣言により失敗リスクあり。
- `InstanceAnalyzer` のフレーム分割が固定長で仕様の粒度と乖離。

### TODO（優先度順）
- [ ] 高: Jinja2テンプレート導入と `Orchestrator` 連携（`report_template.md.j2` 等）
- [ ] 高: ベースライン取得をDWHから実装（比較ロジック置換）
- [ ] 高: RAG + LLM 仮説生成/検証フック導入（仕様/コード検索）
- [ ] 高: 仮説生成、仮説検証時、レポート作成時にpandasai を使用する
- [ ] 高: CLIエントリポイント修正（`pyproject.toml` と実体の整合）
- [ ] 高: 成果物のDWH出力（MD/画像/JSON）を `05_analysis_output/` に揃える
- [ ] 中: 並列スケジューラと再試行（指数バックオフ）を `Orchestrator` に追加
- [ ] 中: `summary_reports.md/json` の出力（全体サマリ）
- [ ] 中: 依存関係の整備（`scikit-learn`, `plotly`, 可能なら `pandasai`, `langchain-openai`）
- [ ] 中: 可視化の拡充（ROC/PR 任意）、バーラベルのフォーマット修正
- [ ] 中: ID整合（`evaluation_result_id`/`algorithm_output_id`）の明確化
- [ ] 中: `production_config.yaml` / `development_config.yaml` 追加
- [ ] 中: unit/integrationテストとfixturesの整備
- [ ] 低: JSON Linesログ出力の追加
- [ ] 低: `utils/rag_system.py`/`utils/visualization.py` の追加または設計調整

### 参考（確認対象ファイル）
- `src/ai_analysis_engine/orchestrator/orchestrator.py`
- `src/ai_analysis_engine/performance_analyzer/performance_analyzer.py`
- `src/ai_analysis_engine/instance_analyzer/instance_analyzer.py`
- `src/ai_analysis_engine/utils/data_loader.py`, `src/ai_analysis_engine/utils/expectation_generator.py`
- `config/default_config.yaml`, `pyproject.toml`, `scripts/run_analysis.py`
- `templates/`（未配置）, `tests/`（未整備）